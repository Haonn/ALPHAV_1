<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>Climb - Creaturae</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var config = {// Configuration -----------------------------------------
    type: Phaser.AUTO,
    width: 1920,
    height: 1080,
    physics: {
        default: 'arcade',
        arcade: {
            gravity: { y: 300, x:0 },
            debug: true
        }
    },
    input:{
        gamepad:true
    },
    scene: {
        preload: preload,
        create: create,
        update: update
    }
};
//VARIABLES
var sparkle;
var sparkleGenerator;
var compteurChangmentPouvoir = 61;
var pouvoirchoisi = 1;
var player;
var platforms;
var gameOver = false;
var vie = 3;
var vieText;
var invulnerable = 120;
var ennemis;
var facingLeft = false;
var heart1;
var heart2;
var heart3;
var projectileFeu;
var projectileFeu2;
var projectileFeuActif = false;
var projectileFoudre;
var projectileFoudre2;
var projectileFoudreActif = false; 
var ennemis;
var ennemi1;
var ennemi2;


var game = new Phaser.Game(config);

//PRELOAD

function preload ()//----------------------------------------
{
    //
    this.load.image('background','assets/experimentalBackground.png');
    this.load.image('heart','assets/heart.png');
    this.load.image('powerup','assets/power_up.png');
    //checkpoint
    this.load.image('check','assets/checkpoint.png');
    //Plateformes et arrière-plan----------
    this.load.image('carte', 'assets/carte.png');
    this.load.image('ground', 'assets/platform.png');
    this.load.image('neige','assets/neige.png');
    this.load.image('glace','assets/glace.png');
    this.load.image('roche','assets/roche.png');
    this.load.image("thunderProjectile", "assets/thunderProjectile.png");
    //Ennemi ----------
    this.load.spritesheet('ennemis','assets/ennemi.png', { frameWidth: 54, frameHeight:  122});
    //piege
    this.load.image('piege','assets/piege_cristallin.png');
    //Attaque/PullBox ----------
    this.load.image('attaque','assets/attaque.png'); 
    //Player----------
    this.load.spritesheet('dude', 'assets/perso_base.png', { frameWidth: 80, frameHeight:  110});
    this.load.spritesheet('grappin', 'assets/grappin.png', { frameWidth: 11, frameHeight:  168});
    //Sorts
    //Foudre
    this.load.image('thunder','assets/thunder.png');
    //Feu
    this.load.image('firebolt','assets/firebolt.png');

}

function create ()//----------------------------------------
{

    // Caméra
    this.add.image(960,540, 'background')
    this.cameras.main.setSize(1920,1080);

    //PLACEMENTS
    player = this.physics.add.sprite(60, 950, 'dude').setOffset(8, -10);
    platforms = this.physics.add.staticGroup();
    projectileFoudre = this.physics.add.group();
    projectileFeu = this.physics.add.group();

    platforms.create(50,1060, 'ground');
    platforms.create(250, 1060, 'ground');
    platforms.create(450,1060, 'ground');
    platforms.create(650,1060, 'ground');
    platforms.create(850,1060, 'ground');
    platforms.create(1050,1060, 'ground');
    platforms.create(1250,1060, 'ground');
    platforms.create(1450,1060, 'ground');
    platforms.create(1650,1060, 'ground');
    platforms.create(1750,1060, 'ground');


    //ENNEMIS
    ennemis = this.physics.add.group();
    ennemi1 = ennemis.create(1320, 950, "ennemis");
    ennemi2 = ennemis.create(1460, 950, "ennemis");

    // Animations ennemi ----------
    this.anims.create({
        key: 'idleLeftEnnemi',
        frames: this.anims.generateFrameNumbers('ennemis', { start: 0, end: 30 }),
        frameRate: 30,
        repeat: 1
    });
    this.anims.create({
        key: 'runningLeftEnnemi',
        frames: this.anims.generateFrameNumbers('ennemis', { start: 30, end: 60 }),
        frameRate: 30,
        repeat: 1
    });
    this.anims.create({
        key: 'runningRightEnnemi',
        frames: this.anims.generateFrameNumbers('ennemis', { start: 91, end: 121 }),
        frameRate: 30,
        repeat: 1
    });
    
    //PLAYER
    player.setBounce(0);
    player.setCollideWorldBounds(true);

    this.anims.create({
        key: 'left',
        frames: this.anims.generateFrameNumbers('dude', { start: 125, end: 155 }),
        frameRate: 30,
        repeat: -1
    });

    this.anims.create({
        key: 'attaquePlayer',
        frames: this.anims.generateFrameNumbers('dude', {start : 60, end : 75}),
        frameRate: 30,
        repeat: 0
    })

    this.anims.create({
        key: 'idleRight',
        frames: this.anims.generateFrameNumbers('dude', { start: 1, end: 29}),
        frameRate: 30,
        repeat: -1
    });

    this.anims.create({
        key: 'idleLeft',
        frames: this.anims.generateFrameNumbers('dude', { start: 95, end: 124 }),
        frameRate: 30,
        repeat: -1
    });

    this.anims.create({
        key: 'right',
        frames: this.anims.generateFrameNumbers('dude', { start: 30, end: 60 }),
        frameRate: 30,
        repeat: -1
    });

    this.anims.create({
        key: 'jumpRight',
        frames: this.anims.generateFrameNumbers('dude', { start: 75, end: 85 }),
        frameRate: 30,
        repeat: 1
    });

    this.anims.create({
        key: 'jumpLeft',
        frames: this.anims.generateFrameNumbers('dude', { start: 170, end: 180 }),
        frameRate: 30,
        repeat: 1
    });

    heart1 = this.add.image(0,0,'heart');
    heart2 = this.add.image(0,0,'heart');
    heart3 = this.add.image(0,0,'heart');

    cursors = this.input.keyboard.createCursorKeys();




    function UX()
    {
        heart1.x = player.body.position.x -600 ;
        heart1.y = player.body.position.y-540 ;
        if (vie==1)
        {
            heart3.setAlpha(1,1,1,1);
            heart2.setAlpha(0,0,0,0);
            heart1.setAlpha(0,0,0,0);
        }
        heart2.x = player.body.position.x -630 ;
        heart2.y = player.body.position.y -540 ;
        if (vie==2)
        {
            heart3.setAlpha(1,1,1,1);
            heart2.setAlpha(1,1,1,1);
            heart1.setAlpha(0,0,0,0);
        }
        heart3.x = player.body.position.x -660 ;
        heart3.y = player.body.position.y -540;
        if (vie == 3)
        {
            heart3.setAlpha(1,1,1,1);
            heart2.setAlpha(1,1,1,1);
            heart1.setAlpha(1,1,1,1);
        }
    }
     //projectile de foudre 
     this.projectileFoudre2 = this.physics.add.group({
            defaultKey: 'thunderProjectile',
            maxSize: 1000,
            allowGravity: false,
        });
        
    //projectile de feu 
    this.projectileFeu2 = this.physics.add.group({
            defaultKey: 'attaque',
            maxSize: 1000,
            allowGravity: false,
        });
        this.input.on('pointerdown', shoot, this);
}
function shoot(pointer) {
    if (pouvoirchoisi == 1)
    {
        console.log(pointer.x, pointer.y);

        var sparkle = this.add.particles('thunder');
        var sparkleGenerator = sparkle.createEmitter({
            speed: 100,
            scale : {start: 0.2, end: 0},
            blendMode:'COLOR_BRUN'
        });


      var projectileFoudre2 = this.projectileFoudre2.get(player.x, player.y);
      if (projectileFoudre2) {
        projectileFoudre2.setActive(true);
        projectileFoudre2.setVisible(true);

          //Calcul de coordonnées du vecteur entre les deux projectiles
          dY = ( pointer.y - player.body.position.y);
          dX = ( pointer.x - player.body.position.x);

          //Distance à ajouter pour atteindre la constante vitesse.
          dSpeed = (800/(Math.abs(dY)+Math.abs(dX))); 

          projectileFoudre2.body.velocity.y = dY*dSpeed;
          projectileFoudre2.body.velocity.x = dX*dSpeed;
        sparkleGenerator.startFollow(projectileFoudre2);
      }
    }
    else if (pouvoirchoisi == 2)
    {
      var projectileFeu2 = this.projectileFeu2.get(player.x, player.y);
      if (projectileFeu2) {
        projectileFeu2.setActive(true);
        projectileFeu2.setVisible(true);


          //Calcul de coordonnées du vecteur entre les deux projectiles
          dY = ( pointer.y - player.y);
          dX = ( pointer.x - player.x);

          //Distance à ajouter pour atteindre la constante vitesse.
          dSpeed = (800/(Math.abs(dY)+Math.abs(dX))); 

          projectileFeu2.body.velocity.y = dY*dSpeed;
          projectileFeu2.body.velocity.x = dX*dSpeed;
  
      }
    }
    //this.physics.add.collider(this.projectileFoudre2, A,Fx);
    //this.physics.add.collider(this.projectileFeu2, A,Fx);
   
}
function update () //------------------------------------------
{
    this.cameras.main.startFollow(player, false,0,0,-225,100);
    if (gameOver)
    {
        console.log("MORT");
        player.x = 0;
        player.y = 0;
       

        vie = 3;
        gameOver=false;
    }
    //Déplacement à gauche----------

    if (cursors.left.isDown)
    {
        facingLeft = true;
        if (pouvoirchoisi !=1)
        {
            player.setVelocityX(-160);
        }
        if (pouvoirchoisi ==1)
        {
            player.setVelocityX(-240);
        }
        if (player.body.touching.down == true)
        {
            player.anims.play('left', true );
        }
        
    }
    //Déplacement à droite ----------
    else if (cursors.right.isDown)
    {
        facingLeft=false;

        if (pouvoirchoisi !=1)
        {
            player.setVelocityX(160);
        }
        if (pouvoirchoisi ==1)
        {
            player.setVelocityX(240);
        }

        player.anims.play('right', true);
    }
        
    //Aucun déplacement souhaité-----------
    else
    {
         player.setVelocityX(0);

            if (player.body.touching.down == true)
            {
                if (facingLeft==false ){    
                player.anims.play('idleRight',true);
                }
                else{
                    player.anims.play('idleLeft',true);
                }
            }
    }
       
    //Déplacement hauteur ----------
    if (cursors.up.isDown)
    {
        if (player.body.touching.down)
        {
            player.anims.play('jump',true);
            player.setVelocityY(-330);
        }
        
    }

    //Changement de pouvoir 
    if (cursors.space.isDown && compteurChangmentPouvoir > 60 && cursors.up.isUp && cursors.down.isUp && cursors.left.isUp && cursors.right.isUp )
    {
        if (pouvoirchoisi== 1)
        {
            pouvoirchoisi = 2;
            console.log(pouvoirchoisi);
            compteurChangmentPouvoir = 0;
        }

        else if (pouvoirchoisi== 2)
        {
            pouvoirchoisi = 3;
            console.log(pouvoirchoisi);
            compteurChangmentPouvoir = 0;
        }

        else if (pouvoirchoisi== 3)
        {
            resetVent()
            pouvoirchoisi = 1;
            console.log(pouvoirchoisi);
            resetVent()
            compteurChangmentPouvoir = 0;
        }
    }
    //Pouvoir de foudre
    


    //Pouvoir du feu
    if (pouvoirchoisi == 2 && projectileFeuActif == false)
        {
            if (cursors.space.isDown && cursors.up.isDown)
            {
                projectileFeu.create(player.x, (player.y-30), 'firebolt')
                projectileFeu.setVelocityY(-300);
                projectileFeuActif = true; 
            }
            if (cursors.space.isDown && cursors.down.isDown)
            {
                projectileFeu.create(player.x, (player.y-30), 'firebolt')
                projectileFeu.setVelocityY(300);
                projectileFeuActif = true; 
            }
            if (cursors.space.isDown && cursors.left.isDown)
            {
                projectileFeu.create(player.x, (player.y-30), 'firebolt')
                projectileFeu.setVelocityX(-300);
                projectileFeuActif = true; 
            }
            if (cursors.space.isDown && cursors.right.isDown)
            {
                projectileFeu.create(player.x, (player.y-30), 'firebolt')
                projectileFeu.setVelocityX(300);
                projectileFeuActif = true; 
            }
            
        }

    //Pouvoir du vent 

    if (pouvoirchoisi == 3)
    {
        if (cursors.space.isDown && cursors.up.isDown)
        {
            resetVent()
            player.setGravityY(-100)
        }
        if (cursors.space.isDown && cursors.down.isDown)
        {
            resetVent()
            player.setGravityY(700)
        }
        if (cursors.space.isDown && cursors.left.isDown)
        {
            resetVent()
            player.setGravityX(-5000)
        }
        if (cursors.space.isDown && cursors.right.isDown)
        {
            resetVent()
            player.setGravityX(5000)
        }
    }
    //COLLIDERS
    this.physics.add.collider(player, platforms);
    this.physics.add.collider(projectileFeu, platforms);
    this.physics.add.collider(ennemis, platforms);
    this.physics.add.overlap(ennemis, projectileFeu,hitEnnemiFeu,null,this );


    deplacementEnnemi();
    invulnerable ++;
    compteurChangmentPouvoir ++;

    function resetVent(){
        player.setGravityX(0);
        player.setGravityY(300);
    }

    function hitEnnemiFeu(ennemi)
    {        
        ennemi.disableBody(true,true);
        //projectileFeu.setAlpha(0,0,0,0);
        projectileFeuActif = false;
        console.log("ennemi touché par le feu")

    }

    function deplacementEnnemi(ennemis){ //Pour que l'ennemi suive le joueur
   
    if(player.body.position.y > (ennemi1.body.position.y-500) && (player.body.position.y < (ennemi1.body.position.y+500))) 
        {
        if (player.body.position.x < ennemi1.body.position.x && player.body.position.x > (ennemi1.body.position.x-500) )
        {
            ennemi1.setVelocityX(-180);
            ennemi1.anims.play('runningLeftEnnemi', true );        
        }
        else if (player.body.position.x > ennemi1.body.position.x && player.body.position.x < (ennemi1.body.position.x+450) ){
            ennemi1.setVelocityX(180);
            ennemi1.anims.play('runningRightEnnemi', true ); 
        }

        else{
            ennemi1.setVelocityX(0);
            ennemi1.anims.play('idleLeftEnnemi', true );
        }
    }
    
    // ennemi2
    if(player.body.position.y > (ennemi2.body.position.y-500) && (player.body.position.y < (ennemi2.body.position.y+500))) 
        {
        if (player.body.position.x < ennemi2.body.position.x && player.body.position.x > (ennemi2.body.position.x-500) )
        {
            ennemi2.setVelocityX(-180);
            ennemi2.anims.play('runningLeftEnnemi', true );           
        }
        else if (player.body.position.x > ennemi2.body.position.x && player.body.position.x < (ennemi2.body.position.x+450) ){
            ennemi2.setVelocityX(180);
            ennemi2.anims.play('runningRightEnnemi', true );
        }

        else{
            ennemi2.setVelocityX(0);
            ennemi2.anims.play('idleLeftEnnemi', true );
        }
    }

}
    function degat ()
    {
        if (invulnerable > 60)
        {
            if (vie > 0 )
            {
                vie -= 1;
                invulnerable = 0;
            }
            else 
            {
                gameOver = true;
            }
        }
        this.bullets.children.each(function(b) {
    if (b.active) {
        if (b.y < 0) {
            b.setActive(false);
        }
    }
}.bind(this));
    }
}   
</script>

</body>
</html>